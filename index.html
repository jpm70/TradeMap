<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Finder Pro - Final</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        :root { --bg: #f0f2f5; --card: #fff; --text: #333; --border: #ddd; }
        body.dark-mode { --bg: #1a1a1a; --card: #2d2d2d; --text: #eee; --border: #444; }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: var(--bg); color: var(--text); transition: 0.3s; }
        .container { max-width: 1000px; margin: auto; background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; position: relative; }
        
        .autocomplete-container { flex: 1; position: relative; min-width: 250px; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: inherit; color: inherit; box-sizing: border-box; }
        
        #suggestions {
            position: absolute; top: 100%; left: 0; right: 0; 
            background: var(--card); border: 1px solid var(--border); 
            z-index: 3000; border-radius: 0 0 6px 6px; display: none;
        }
        .suggestion-item { padding: 12px; cursor: pointer; border-bottom: 1px solid var(--border); color: var(--text); }
        .suggestion-item:hover { background: #3498db; color: white; }

        button { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-search { background: #3498db; color: white; }
        .btn-geo { background: #27ae60; color: white; }

        #map { height: 500px; width: 100%; border-radius: 10px; border: 1px solid var(--border); z-index: 1; }
        .custom-div-icon { background: #3498db; border: 2px solid white; border-radius: 50%; color: white; text-align: center; line-height: 30px; }
        .btn-route { display: block; margin-top: 10px; background: #4285F4; color: white !important; text-decoration: none; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px; }
        .loading { display: none; text-align: center; padding: 10px; color: #3498db; font-weight: bold; }
    </style>
</head>
<body class="dark-mode">

<div class="container">
    <div class="header">
        <h2 style="margin:0">游늸 Business Finder Pro</h2>
        <button style="background:#666; color:white" onclick="toggleTheme()">游깹 Tema</button>
    </div>
    
    <div class="search-box">
        <div class="autocomplete-container">
            <input type="text" id="ciudadInput" placeholder="Escribe ciudad..." autocomplete="off">
            <div id="suggestions"></div>
        </div>
        <select id="actividad" style="flex: 0.5;">
            <option value="amenity=restaurant">Restaurantes</option>
            <option value="amenity=cafe">Cafeter칤as</option>
            <option value="amenity=pharmacy">Farmacias</option>
            <option value="shop=supermarket">Supermercados</option>
            <option value="amenity=bar">Bares</option>
        </select>
        <button class="btn-search" onclick="realizarBusqueda()">Buscar</button>
        <button class="btn-geo" onclick="usarUbicacion()">游늸 Mi ubicaci칩n</button>
    </div>
    
    <div id="status" class="loading">Cargando...</div>
    <div id="map"></div>
</div>

<script>
    let isDark = true;
    let ciudadCoords = null;
    const map = L.map('map').setView([40.41, -3.70], 6);
    
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '춸 CARTO' });
    const lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '춸 OpenStreetMap' });
    darkTiles.addTo(map);

    let marcadores = L.layerGroup().addTo(map);

    function toggleTheme() {
        isDark = !isDark;
        document.body.classList.toggle('dark-mode');
        if (isDark) { map.removeLayer(lightTiles); darkTiles.addTo(map); }
        else { map.removeLayer(darkTiles); lightTiles.addTo(map); }
    }

    // --- MEJORA: Autocomplete m치s sensible ---
    const input = document.getElementById('ciudadInput');
    const suggBox = document.getElementById('suggestions');

    input.addEventListener('input', async () => {
        const val = input.value.trim();
        if (val.length < 3) { suggBox.style.display = 'none'; return; }

        try {
            const res = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(val)}&limit=5`);
            const data = await res.json();
            suggBox.innerHTML = "";
            data.features.forEach(f => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = `${f.properties.name} (${f.properties.state || ''}, ${f.properties.country})`;
                div.onclick = () => {
                    ciudadCoords = { lat: f.geometry.coordinates[1], lon: f.geometry.coordinates[0] };
                    input.value = f.properties.name;
                    suggBox.style.display = 'none';
                    map.setView([ciudadCoords.lat, ciudadCoords.lon], 13);
                };
                suggBox.appendChild(div);
            });
            suggBox.style.display = 'block';
        } catch (e) { console.log("Autocomplete error"); }
    });

    async function realizarBusqueda() {
        const tag = document.getElementById('actividad').value;
        const status = document.getElementById('status');
        
        // Si no seleccion칩 de la lista, intentamos buscar el 치rea por nombre como plan B
        if (!ciudadCoords) {
            const ciudadTexto = input.value.trim();
            if (!ciudadTexto) return alert("Escribe una ciudad");
            
            status.style.display = "block";
            const queryArea = `[out:json];area["name"="${ciudadTexto}"]["admin_level"~"4|8"];out center;`;
            try {
                const res = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(queryArea));
                const data = await res.json();
                if (data.elements[0]) {
                    const c = data.elements[0].center || data.elements[0];
                    ciudadCoords = { lat: c.lat, lon: c.lon };
                } else {
                    status.style.display = "none";
                    return alert("Selecciona una ciudad de la lista de sugerencias que aparece al escribir.");
                }
            } catch (e) { alert("Error buscando ciudad"); return; }
        }

        const query = `[out:json][timeout:30];
            (node[${tag}](around:3000, ${ciudadCoords.lat}, ${ciudadCoords.lon});
             way[${tag}](around:3000, ${ciudadCoords.lat}, ${ciudadCoords.lon}););
            out center;`;
        ejecutarQuery(query);
    }

    async function ejecutarQuery(query) {
        const status = document.getElementById('status');
        status.style.display = "block";
        marcadores.clearLayers();
        try {
            const res = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query));
            const data = await res.json();
            data.elements.forEach(el => {
                const lat = el.lat || el.center.lat, lon = el.lon || el.center.lon;
                const icon = L.divIcon({ html: `<i class="fa-solid fa-location-dot"></i>`, className: 'custom-div-icon', iconSize:[30,30], iconAnchor:[15,15] });
                L.marker([lat, lon], {icon}).addTo(marcadores)
                    .bindPopup(`<b style="color:#333">${el.tags.name || "Negocio"}</b><br>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank" class="btn-route">C칩mo llegar</a>`);
            });
            if (data.elements.length === 0) alert("No se encontraron resultados.");
        } catch (e) { alert("Error de red"); }
        status.style.display = "none";
    }

    function usarUbicacion() {
        navigator.geolocation.getCurrentPosition(pos => {
            ciudadCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            input.value = "Mi ubicaci칩n";
            map.setView([ciudadCoords.lat, ciudadCoords.lon], 15);
            realizarBusqueda();
        });
    }
</script>
</body>
</html>
