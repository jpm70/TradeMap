<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Finder Pro - Corregido</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        :root { --bg-body: #f0f2f5; --bg-card: #ffffff; --text-main: #333; --border: #ddd; --input-bg: #fff; }
        body.dark-mode { --bg-body: #1a1a1a; --bg-card: #2d2d2d; --text-main: #eee; --border: #444; --input-bg: #3d3d3d; }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: var(--bg-body); color: var(--text-main); transition: 0.3s; }
        .container { max-width: 1000px; margin: auto; background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); position: relative; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        
        /* Contenedor del Autocomplete */
        .autocomplete-container { flex: 1; position: relative; min-width: 250px; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); box-sizing: border-box; }
        
        .suggestions {
            position: absolute; top: 100%; left: 0; right: 0; 
            background: var(--bg-card); border: 1px solid var(--border); 
            z-index: 2000; border-radius: 0 0 6px 6px; max-height: 250px; overflow-y: auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: none;
        }
        .suggestion-item { padding: 12px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 14px; color: var(--text-main); }
        .suggestion-item:hover { background: #3498db; color: white; }

        button { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-search { background: #3498db; color: white; }
        .btn-geo { background: #27ae60; color: white; }
        
        #map { height: 500px; width: 100%; border-radius: 10px; border: 1px solid var(--border); margin-top: 10px; z-index: 1; }
        
        .custom-div-icon {
            background: #3498db; border: 2px solid white; border-radius: 50%;
            color: white; text-align: center; line-height: 30px; font-size: 14px;
        }
        .btn-route {
            display: block; margin-top: 10px; background: #4285F4; color: white !important;
            text-decoration: none; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;
        }
        .loading { display: none; text-align: center; padding: 10px; color: #3498db; font-weight: bold; }
    </style>
</head>
<body class="dark-mode">

<div class="container">
    <div class="header">
        <h2 style="margin:0"> Business Finder Pro</h2>
        <button style="background:#666; color:white" onclick="toggleTheme()"> Cambiar Tema</button>
    </div>
    
    <div class="search-box">
        <div class="autocomplete-container">
            <input type="text" id="ciudadInput" placeholder="Escribe ciudad (ej: Alicante...)" onkeyup="buscarSugerencias()">
            <div id="suggestions" class="suggestions"></div>
        </div>

        <select id="actividad" style="flex: 0.5;">
            <option value="amenity=restaurant">Restaurantes</option>
            <option value="amenity=cafe">Cafeter铆as</option>
            <option value="amenity=pharmacy">Farmacias</option>
            <option value="shop=supermarket">Supermercados</option>
            <option value="amenity=bar">Bares</option>
            <option value="amenity=fuel">Gasolineras</option>
        </select>

        <button class="btn-search" onclick="realizarBusqueda()">Buscar</button>
        <button class="btn-geo" onclick="usarUbicacion()"> Mi ubicaci贸n</button>
    </div>
    
    <div id="status" class="loading">Buscando datos...</div>
    <div id="map"></div>
</div>

<script>
    // Configuraci贸n de Mapas
    let isDark = true;
    const map = L.map('map').setView([40.41, -3.70], 6);
    
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '漏 CARTO' });
    const lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '漏 OpenStreetMap' });

    // Iniciar con mapa oscuro
    darkTiles.addTo(map);
    
    let marcadores = L.layerGroup().addTo(map);
    let ciudadCoords = null;

    // --- FUNCIONES DE TEMA ---
    function toggleTheme() {
        isDark = !isDark;
        document.body.classList.toggle('dark-mode');
        if (isDark) {
            if (map.hasLayer(lightTiles)) map.removeLayer(lightTiles);
            darkTiles.addTo(map);
        } else {
            if (map.hasLayer(darkTiles)) map.removeLayer(darkTiles);
            lightTiles.addTo(map);
        }
    }

    // --- LGICA AUTOCOMPLETE ---
    async function buscarSugerencias() {
        const input = document.getElementById('ciudadInput');
        const lista = document.getElementById('suggestions');
        const query = input.value.trim();

        if (query.length < 3) {
            lista.style.display = 'none';
            return;
        }

        try {
            const response = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=5&lang=es`);
            const data = await response.json();
            
            if (data.features.length > 0) {
                lista.innerHTML = "";
                data.features.forEach(f => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    const nombre = f.properties.name || "";
                    const pais = f.properties.country || "";
                    const estado = f.properties.state || "";
                    
                    item.innerText = `${nombre} (${estado}, ${pais})`;
                    item.onclick = () => {
                        ciudadCoords = { 
                            lat: f.geometry.coordinates[1], 
                            lon: f.geometry.coordinates[0] 
                        };
                        input.value = nombre;
                        lista.style.display = 'none';
                        map.setView([ciudadCoords.lat, ciudadCoords.lon], 13);
                    };
                    lista.appendChild(item);
                });
                lista.style.display = 'block';
            }
        } catch (e) {
            console.error("Error en autocomplete", e);
        }
    }

    // Cerrar sugerencias si se hace clic fuera
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.autocomplete-container')) {
            document.getElementById('suggestions').style.display = 'none';
        }
    });

    // --- BSQUEDA ---
    async function realizarBusqueda() {
        if (!ciudadCoords) {
            alert("Por favor, selecciona una ciudad de la lista de sugerencias que aparece al escribir.");
            return;
        }
        
        const tag = document.getElementById('actividad').value;
        const query = `[out:json][timeout:30];
            (node[${tag}](around:3000, ${ciudadCoords.lat}, ${ciudadCoords.lon});
             way[${tag}](around:3000, ${ciudadCoords.lat}, ${ciudadCoords.lon}););
            out center;`;
        ejecutarQuery(query);
    }

    function usarUbicacion() {
        if (!navigator.geolocation) return alert("Geolocalizaci贸n no soportada");
        
        navigator.geolocation.getCurrentPosition(pos => {
            ciudadCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            document.getElementById('ciudadInput').value = "Mi ubicaci贸n actual";
            map.setView([ciudadCoords.lat, ciudadCoords.lon], 15);
            realizarBusqueda();
        }, () => alert("Permiso de ubicaci贸n denegado."));
    }

    async function ejecutarQuery(query) {
        document.getElementById('status').style.display = "block";
        marcadores.clearLayers();
        try {
            const response = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query));
            const data = await response.json();
            
            if (data.elements.length === 0) alert("No se encontraron negocios en esta zona.");

            data.elements.forEach(el => {
                const lat = el.lat || (el.center && el.center.lat);
                const lon = el.lon || (el.center && el.center.lon);
                
                if (lat && lon) {
                    const customIcon = L.divIcon({ 
                        html: `<i class="fa-solid fa-location-dot"></i>`, 
                        className: 'custom-div-icon', 
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });
                    
                    const name = el.tags.name || "Negocio";
                    const gmapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
                    
                    L.marker([lat, lon], {icon: customIcon}).addTo(marcadores)
                        .bindPopup(`
                            <div style="color: #333">
                                <b>${name}</b><br>
                                <a href="${gmapsUrl}" target="_blank" class="btn-route">C贸mo llegar</a>
                            </div>
                        `);
                }
            });
        } catch (e) { alert("Error al conectar con los datos."); }
        document.getElementById('status').style.display = "none";
    }
</script>
</body>
</html>